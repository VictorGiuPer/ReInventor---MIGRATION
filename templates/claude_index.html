<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <title>ReInventor (Flask)</title>
      <style>
         /* ============================= */
         /* RESET & BASE STYLES           */
         /* ============================= */
         * {
         margin: 0;
         padding: 0;
         box-sizing: border-box;
         }
         body {
         font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
         background-color: #111937;   /* dark app background */
         color: #FFFFFF;              /* default text color */
         line-height: 1.6;
         min-height: 100vh;
         }
         /* ============================= */
         /* LAYOUT CONTAINER              */
         /* ============================= */
         .container {
         max-width: 1100px;
         margin: 0 auto;
         padding: 40px 24px;
         }
         /* ============================= */
         /* HEADER                        */
         /* ============================= */
         h1 {
         font-size: 32px;
         font-weight: 700;
         color: #FFFFFF;
         margin-bottom: 8px;
         letter-spacing: -0.5px;
         }
         h2 {
         font-size: 24px;
         font-weight: 600;
         color: #FFFFFF;
         margin-top: 40px;
         margin-bottom: 20px;
         letter-spacing: -0.3px;
         }
         h3 {
         font-size: 18px;
         font-weight: 600;
         color: #FFFFFF;
         margin-bottom: 12px;
         }
         h4 {
         font-size: 15px;
         font-weight: 600;
         color: #FFFFFF;
         margin-bottom: 8px;
         }
         p {
         margin-bottom: 16px;
         color: #FFFFFF;
         }
         /* ============================= */
         /* FORM ELEMENTS                 */
         /* ============================= */
         label {
         display: block;
         font-weight: 500;
         font-size: 14px;
         color: #FFFFFF;
         margin-bottom: 8px;
         }
         input[type="text"],
         input[type="number"],
         textarea,
         select {
         width: 100%;
         padding: 12px 16px;
         font-size: 15px;

         /* text */
         color: #FFFFFF;

         /* background */
         background-color: rgba(191, 191, 191, 0.4);  /* #BFBFBF @ 40% */

         /* border */
         border: 1px solid rgba(255, 255, 255, 0.6);
         border-radius: 8px;

         margin-bottom: 20px;
         font-family: inherit;
         transition: all 0.2s ease;
         }

         input[type="text"]:focus,
         input[type="number"]:focus,
         textarea:focus,
         select:focus {
         outline: none;
         border-color: #00D5D0;
         box-shadow: 0 0 0 2px rgba(0, 213, 208, 0.35);
         }

         textarea {
         resize: vertical;
         min-height: 100px;
         }
         select[multiple] {
         padding: 8px;
         min-height: 200px;
         }
         select[multiple] option {
         padding: 8px 12px;
         border-radius: 4px;
         margin-bottom: 4px;
         }
         /* ============================= */
         /* BUTTONS                       */
         /* ============================= */
         button {
         padding: 12px 24px;
         font-size: 15px;
         font-weight: 600;
         color: #FFFFFF;
         background-color: #2563EB;
         border: none;
         border-radius: 8px;
         cursor: pointer;
         transition: all 0.2s ease;
         font-family: inherit;
         }
         button:hover {
         background-color: #1d4ed8;
         transform: translateY(-1px);
         box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
         }
         button:active {
         transform: translateY(0);
         }
         button[name="action"][value="skip_round_3"] {
         background-color: #F5F7FA;
         color: #111827;
         border: 2px solid #D1D5DB;
         margin-left: 12px;
         }
         button[name="action"][value="skip_round_3"]:hover {
         background-color: #EFF6FF;
         border-color: #60A5FA;
         transform: translateY(-1px);
         box-shadow: 0 4px 12px rgba(96, 165, 250, 0.2);
         }
         /* ============================= */
         /* CARDS & BOXES                 */
         /* ============================= */
         .card {
         background: #F5F7FA;
         padding: 24px;
         border-radius: 12px;
         margin-bottom: 24px;
         border: 1px solid #D1D5DB;
         }
         .box {
         background: #F5F7FA;
         padding: 20px;
         margin: 24px 0;
         border-left: 4px solid #60A5FA;
         border-radius: 8px;
         }
         .warning {
         background: #FEF2F2;
         padding: 16px 20px;
         border-left: 4px solid #DC2626;
         border-radius: 8px;
         margin-bottom: 24px;
         color: #991B1B;
         font-weight: 500;
         }
         /* ============================= */
         /* CLARIFICATION SECTION         */
         /* ============================= */
         .clarification-box {
         background: #EFF6FF;
         padding: 24px;
         margin-bottom: 32px;
         border-radius: 12px;
         border: 2px solid #60A5FA;
         }
         .clarification-box h3 {
         color: #1E40AF;
         margin-bottom: 12px;
         }
         .clarification-box p {
         color: #1E3A8A;
         line-height: 1.7;
         }
         .clarification-grid {
         display: grid;
         grid-template-columns: 1fr 1fr;
         gap: 24px;
         margin-top: 24px;
         }
         .clarification-item {
         display: flex;
         flex-direction: column;
         }
         .fixed-label {
         font-weight: 600;
         margin-bottom: 8px;
         line-height: 1.4;
         min-height: 4.5em;
         color: #111827;
         font-size: 14px;
         }
         /* ============================= */
         /* CRITIQUE ROUND LAYOUT         */
         /* ============================= */
         .critique-grid {
         display: grid;
         grid-template-columns: 1.2fr 1fr;
         gap: 32px;
         margin: 32px 0;
         }
         .critique-box {
         background: #F5F7FA;
         padding: 24px;
         border-radius: 12px;
         border: 1px solid #D1D5DB;
         }
         .critique-box h3 {
         color: #111827;
         margin-bottom: 16px;
         padding-bottom: 12px;
         border-bottom: 2px solid #D1D5DB;
         }
         .critique-content {
         max-height: 500px;
         overflow-y: auto;
         white-space: pre-wrap;
         line-height: 1.7;
         color: #111827;
         padding-right: 8px;
         }
         .critique-content::-webkit-scrollbar {
         width: 8px;
         }
         .critique-content::-webkit-scrollbar-track {
         background: #F5F7FA;
         border-radius: 4px;
         }
         .critique-content::-webkit-scrollbar-thumb {
         background: #D1D5DB;
         border-radius: 4px;
         }
         .critique-content::-webkit-scrollbar-thumb:hover {
         background: #60A5FA;
         }
         .critique-responses {
         display: flex;
         flex-direction: column;
         }
         .critique-responses h3 {
         margin-bottom: 8px;
         }
         .critique-responses p {
         font-size: 14px;
         color: #6B7280;
         margin-bottom: 20px;
         }
         .critique-responses .clarification-item {
         margin-bottom: 20px;
         }
         .critique-responses textarea {
         margin-bottom: 0;
         }
         /* ============================= */
         /* ACKNOWLEDGEMENT BOX           */
         /* ============================= */
         .ack-box {
         max-width: 800px;
         margin: 32px auto;
         padding: 24px;
         background: #EFF6FF;
         border-left: 4px solid #2563EB;
         border-radius: 12px;
         }
         .ack-box h4 {
         color: #1E40AF;
         margin-bottom: 12px;
         font-size: 16px;
         }
         .ack-box pre {
         margin: 0;
         white-space: pre-wrap;
         word-break: break-word;
         font-family: inherit;
         color: #FFFFFF;
         line-height: 1.7;
         }
         /* ============================= */
         /* FORM SECTIONS                 */
         /* ============================= */
         form {
         background: transparent;        /* no fill */
         padding: 32px;
         border-radius: 12px;
         border: 1px solid #FFFFFF;      /* white outline */
         margin-top: 24px;
         }
         form button[type="submit"] {
         margin-top: 8px;
         }
         /* Center aligned forms */
         form[style*="text-align:center"] {
         border: none;
         padding: 0;
         }
         /* ============================= */
         /* STEP INDICATOR (optional)     */
         /* ============================= */
         .step-indicator {
         background: #EFF6FF;
         padding: 12px 20px;
         border-radius: 8px;
         display: inline-block;
         font-size: 14px;
         font-weight: 600;
         color: #1E40AF;
         margin-bottom: 24px;
         }
         /* ============================= */
         /* RESPONSIVE                    */
         /* ============================= */
         @media (max-width: 768px) {
         .idea-grid {
            grid-template-columns: 1fr;
         }
         }

         h1 {
         font-size: 28px;
         }
         h2 {
         font-size: 22px;
         }
         .clarification-grid,
         .critique-grid {
         grid-template-columns: 1fr;
         gap: 20px;
         }
         form {
         padding: 20px;
         }
         button {
         width: 100%;
         margin-bottom: 12px;
         }
         button[name="action"][value="skip_round_3"] {
         margin-left: 0;
         }
         /* ============================= */
         /* UTILITY CLASSES               */
         /* ============================= */
         .mt-4 { margin-top: 16px; }
         .mt-6 { margin-top: 24px; }
         .mb-4 { margin-bottom: 16px; }
         .mb-6 { margin-bottom: 24px; }
         .text-center { text-align: center; }
         /* ============================= */
         /* SUCCESS MESSAGE               */
         /* ============================= */
         .success-box {
         background: #F0FDF4;
         padding: 24px;
         border-left: 4px solid #16A34A;
         border-radius: 8px;
         margin: 24px 0;
         }
         .success-box h2 {
         color: #15803D;
         margin-top: 0;
         }
         .success-box p {
         color: #166534;
         }
         /* ============================= */
         /* APP LAYOUT                    */
         /* ============================= */
         .app-layout {
         display: flex;
         }

         /* ============================= */
         /* FIXED SIDEBAR                 */
         /* ============================= */
         .sidebar {
         position: fixed;
         top: 0;
         left: 0;
         width: 260px;
         height: 100vh;
         background-color: #F2F2F2;
         display: flex;
         flex-direction: column;
         z-index: 100;

         /* subtle rounding on right edge only */
         border-top-right-radius: 6px;
         border-bottom-right-radius: 6px;

         /* prevents gradient/content from bleeding outside */
         overflow: hidden;
         }

         /* ============================= */
         /* MAIN CONTENT                  */
         /* ============================= */
         .main-content {
         margin-left: 260px;
         flex: 1;
         height: 100vh;
         overflow-y: auto;
         padding: 40px 24px;
         background-color: transparent;
         }
         /* ============================= */
         /* SIDEBAR INTERNAL STYLES       */
         /* ============================= */

         .sidebar-inner {
         display: flex;
         flex-direction: column;
         padding: 20px 16px;
         gap: 28px;
         }

         /* Gradient bar */
         .sidebar-gradient {
         height: 24px;
         background: linear-gradient(
            90deg,
            #111937 0%,
            #0057AB 30%,
            #1DB6F3 70%,
            #00D5D0 100%
         );
         }

         /* Logo */
         .sidebar-logo {
         padding: 12px 4px;
         }

         .logo-placeholder {
         font-size: 14px;
         font-weight: 600;
         color: #111937;
         line-height: 1.2;
         }

         /* Progress */
         .sidebar-progress {
         display: flex;
         flex-direction: column;
         gap: 8px;
         }

         .progress-label {
         font-size: 13px;
         font-weight: 600;
         color: #111937;
         }

         .progress-track {
         height: 6px;
         background-color: #E5E7EB;
         border-radius: 4px;
         overflow: hidden;
         }

         .progress-fill {
         height: 100%;
         width: 0%;
         background-color: #00D5D0;
         transition: width 0.4s ease;
         }


         /* Navigation */
         .sidebar-nav {
         display: flex;
         flex-direction: column;
         gap: 6px;
         }

         .sidebar-nav a {
         padding: 8px 10px;
         font-size: 14px;
         color: #111937;
         text-decoration: none;
         border-radius: 6px;
         }

         .sidebar-nav a:hover {
         background-color: rgba(0, 0, 0, 0.05);
         }

         .sidebar-nav a.active {
         background-color: rgba(0, 213, 208, 0.2);
         font-weight: 600;
         }

         .sidebar-nav a.done {
         opacity: 0.75;
         }

         .sidebar-nav a.done::before {
         content: "‚úì ";
         font-weight: 700;
         color: #00D5D0;
         }
         /* ============================= */
         /* SIDEBAR LOGO                  */
         /* ============================= */

         .sidebar-logo {
         display: flex;
         flex-direction: column;
         align-items: center;       /* horizontal centering */
         gap: 10px;                  /* space between logo and text */
         padding: 0px 0 10px;
         }

         .company-logo {
         height: 60px;              /* larger, brand-forward */
         width: auto;
         display: block;
         }

         .tool-name {
         font-size: 15px;
         font-weight: 700;
         color: #111937;
         line-height: 1;
         letter-spacing: 0.2px;
         }

         /* ============================= */
         /* STEP 0 ‚Äì IDEA LAYOUT          */
         /* ============================= */

         .idea-grid {
         display: grid;
         grid-template-columns: 1fr 1fr;
         gap: 24px;
         }

         .form-group {
         display: flex;
         flex-direction: column;
         }

         /* Bottom-right column stack */
         .stacked-right {
         display: flex;
         flex-direction: column;
         gap: 0px;
         }

         /* Textarea sizing for alignment */
         .textarea-large {
         min-height: 180px;
         }

         .textarea-medium {
         min-height: 140px;
         }

         .textarea-small {
         min-height: 70px;
         }


      </style>
   </head>
   <body>
      <div class="app-layout">
      <!-- ===================== -->
      <!-- SIDEBAR -->
      <!-- ===================== -->
      <aside class="sidebar">

         <!-- Gradient strip -->
         <div class="sidebar-gradient"></div>

         <!-- Sidebar content -->
         <div class="sidebar-inner">
            {% set cs = state.get("current_step", 0) %}

            {% if cs <= 0 %}
            {% set ui_step = 1 %}
            {% elif cs <= 2 %}
            {% set ui_step = 2 %}
            {% elif cs <= 4 %}
            {% set ui_step = 3 %}
            {% elif cs <= 6 %}
            {% set ui_step = 4 %}
            {% elif cs <= 9 %}
            {% set ui_step = 5 %}
            {% elif cs <= 10 %}
            {% set ui_step = 6 %}
            {% elif cs <= 11 %}
            {% set ui_step = 7 %}
            {% else %}
            {% set ui_step = 8 %}
            {% endif %}

            {% set progress_pct = ui_step * 12.5 %}

            <div class="sidebar-logo">
               <img
                  src="{{ url_for('static', filename='invent_logo.png') }}"
                  alt="Company logo"
                  class="company-logo"
               >
               <div class="tool-name">ReInventor</div>
            </div>




            <!-- Progress -->
            <div class="sidebar-progress">
               <span class="progress-label">Progress</span>

               <!-- Put progress percentage into an attribute (no Jinja in style) -->
               <div class="progress-track" data-progress="{{ progress_pct }}">
                  <div class="progress-fill"></div>
               </div>
            </div>


            <nav class="sidebar-nav">
               <a href="#step-1" class="{% if ui_step == 1 %}active{% elif ui_step > 1 %}done{% endif %}">1. Submit Idea</a>
               <a href="#step-2" class="{% if ui_step == 2 %}active{% elif ui_step > 2 %}done{% endif %}">2. Clarify</a>
               <a href="#step-3" class="{% if ui_step == 3 %}active{% elif ui_step > 3 %}done{% endif %}">3. Critique 1</a>
               <a href="#step-4" class="{% if ui_step == 4 %}active{% elif ui_step > 4 %}done{% endif %}">4. Critique 2</a>
               <a href="#step-5" class="{% if ui_step == 5 %}active{% elif ui_step > 5 %}done{% endif %}">5. Critique 3</a>
               <a href="#step-6" class="{% if ui_step == 6 %}active{% elif ui_step > 6 %}done{% endif %}">6. Synthesis</a>
               <a href="#step-7" class="{% if ui_step == 7 %}active{% elif ui_step > 7 %}done{% endif %}">7. Mitigations</a>
               <a href="#step-8" class="{% if ui_step == 8 %}active{% endif %}">8. Context Prompt</a>
            </nav>


         </div>
      </aside>


      <!-- ===================== -->
      <!-- MAIN CONTENT -->
      <!-- ===================== -->
      <main class="main-content">
         <div class="content-card">
            <h1>ReInventor</h1>
            {% if message %}
            <div class="warning">
               {{ message }}
            </div>
            {% endif %}
            <!-- ===================================================== -->
            <!-- STEP 0 ‚Äî SUBMIT IDEA -->
            <!-- ===================================================== -->
            {% if state.current_step >= 0 %}
            <section id="step-1" class="step">
               <h2>Submit Your Idea</h2>
               <form method="post">
               <input type="hidden" name="scroll_y" value="0">

               <div class="idea-grid">

               <!-- Top row -->
               <div class="form-group">
                  <label><strong>Problem</strong></label>
                  <textarea name="problem" class="textarea-large">
                  {{ state.problem or "" }}
                  </textarea>
               </div>

               <div class="form-group">
                  <label><strong>Proposed Approach</strong></label>
                  <textarea name="approach" class="textarea-large">
                  {{ state.approach or "" }}
                  </textarea>
               </div>

               <!-- Bottom left -->
               <div class="form-group">
                  <label><strong>Primary Stakeholder</strong></label>
                  <textarea name="stakeholder" class="textarea-medium">
                  {{ state.stakeholder or "" }}
                  </textarea>
               </div>

               <!-- Bottom right -->
               <div class="form-group stacked-right">
                  <div class="form-group">
                  <label><strong>Constraints / Non-negotiables</strong></label>
                  <textarea name="constraints" class="textarea-small">
                     {{ state.constraints or "" }}
                  </textarea>
                  </div>

                  <div class="form-group">
                  <label><strong>Critique abstraction level</strong></label>
                  <input
                     type="range"
                     name="abstraction"
                     min="0"
                     max="10"
                     value="{{ state.abstraction or 5 }}"
                  >
                  </div>
               </div>

            </div>

            <button type="submit">Generate Clarifying Questions</button>
            </form>

            </section>
            {% endif %}
            <!-- ===================================================== -->
            <!-- STEP 2 ‚Äî CLARIFY -->
            <!-- ===================================================== -->
            {% if state.current_step >= 1 %}
            <section id="step-2" class="step">
               <h2>Clarify and give more context</h2>
               {% if state.current_step >= 1 %}
               <!-- SUBSTEP: QUESTIONS -->
               <div id="step-2-questions"></div>
               <div class="clarification-box">
                  <h3>Reframed Understanding</h3>
                  <p>{{ state.reframed_understanding }}</p>
               </div>
               <form method="post">
                  {% if state.get("clarification_prompts") %}
                  <div class="clarification-grid">
                     {% for i in range(3) %}
                     <!-- LEFT COLUMN -->
                     <div class="clarification-item">
                        <div class="fixed-label" title="{{ state.clarification_prompts[i] }}">
                           {{ state.clarification_prompts[i] }}
                        </div>
                        <textarea name="clarify_answer_{{ i }}" rows="6">{{ state["clarify_answer_" ~ i] or "" }}</textarea>
                     </div>
                     <!-- RIGHT COLUMN -->
                     <div class="clarification-item">
                        <div class="fixed-label" title="{{ state.clarification_prompts[i+3] }}">
                           {{ state.clarification_prompts[i+3] }}
                        </div>
                        <textarea name="clarify_answer_{{ i+3 }}" rows="6">{{ state["clarify_answer_" ~ (i+3)] or "" }}</textarea>
                     </div>
                     {% endfor %}
                  </div>
                  {% endif %}
                  <button type="submit">Generate Context Summary</button>
               </form>
               {% endif %}
               {% if state.current_step >= 2 %}
               <div id="step-2-summary"></div>
               <h3 class="mt-6">Context Summary</h3>
               <p>
                  Review or edit the context summary below before continuing.
               </p>
               <form method="post">
                  <textarea
                     name="context_summary"
                     rows="14"
                     style="width:100%;"
                     >{{ state.context_summary or "" }}</textarea>
                  <div style="margin-top: 15px;">
                     <button type="submit" name="action" value="run_critique_1">
                     Run Critique Round 1
                     </button>
                  </div>
               </form>
               {% endif %}
            </section>
            {% endif %}
            <!-- ===================================================== -->
            <!-- STEP 3 ‚Äî CRITIQUE ROUND 1 -->
            <!-- ===================================================== -->
            {% if state.current_step >= 3 %}
            <section id="step-3" class="step">
               <h2>Critique Round 1</h2>
               <!-- SUBSTEP: CRITIQUE OUTPUT -->
               <div id="step-3-critique"></div>
               <div class="critique-grid">
                  <!-- LEFT: Critique Output -->
                  <div class="critique-box">
                     <h3>Critique</h3>
                     <div class="critique-content">
                        {{ state.critique_round_1 or "" }}
                     </div>
                  </div>
                  <!-- RIGHT: User Responses -->
                  <div class="critique-responses">
                     <h3>Your Responses</h3>
                     <p>Respond to each framework (type '-' if none).</p>
                     {% if state.frameworks_used_round_1 %}
                     <form method="post">
                        {% for fw in state.frameworks_used_round_1 %}
                        <div class="clarification-item">
                           <div class="fixed-label">
                              üí¨ {{ fw }}
                           </div>
                           <textarea
                              name="critique_response_r1_{{ loop.index0 }}"
                              rows="6"
                              >{{ state["critique_response_r1_" ~ loop.index0] or "" }}</textarea>
                        </div>
                        {% endfor %}
                        <button type="submit" name="action" value="submit_r1">
                        Submit Your Reflections
                        </button>
                     </form>
                     {% endif %}
                  </div>
               </div>
               {% if state.current_step >= 4 %}
               <!-- SUBSTEP: ACKNOWLEDGEMENT -->
               <div id="step-3-ack"></div>
               <div class="ack-box mt-6">
                  <h4>Context Update Acknowledgement</h4>
                  <pre>{{ state.acknowledgement_round_1 }}</pre>
               </div>
               <form method="post" style="text-align:center; margin-top: 24px;">
                  <button type="submit">
                  Run Critique Round 2
                  </button>
               </form>
               {% endif %}
            </section>
            {% endif %}
            <!-- ===================================================== -->
            <!-- STEP 5 ‚Äî Critique Round 2 -->
            <!-- ===================================================== -->
            {% if state.current_step >= 5 %}
            <section id="step-4" class="step">
               <h2>Critique Round 2</h2>
               <div id="step-4-critique"></div>
               <div class="critique-grid">
                  <!-- LEFT: Critique Output -->
                  <div class="critique-box">
                     <h3>Critique</h3>
                     <div class="critique-content">
                        {{ state.critique_round_2 }}
                     </div>
                  </div>
                  <!-- RIGHT: User Responses -->
                  <div class="critique-responses">
                     <h3>Your Responses</h3>
                     <p>Respond to each framework (type '-' if none).</p>
                     <form method="post">
                        {% for fw in state.frameworks_used_round_2 %}
                        <div class="clarification-item">
                           <div class="fixed-label">
                              üí¨ {{ fw }}
                           </div>
                           <textarea
                              name="critique_response_r2_{{ loop.index0 }}"
                              rows="6"
                              >{{ state["critique_response_r2_" ~ loop.index0] or "" }}</textarea>
                        </div>
                        {% endfor %}
                        <button type="submit">
                        Submit Your Reflections (Round 2)
                        </button>
                     </form>
                  </div>
               </div>
               {% endif %}
               <!-- ===================================================== -->
               <!-- STEP 6 ‚Äî Context Update -->
               <!-- ===================================================== -->
               {% if state.current_step >= 6 %}
               <div id="step-4-ack"></div>
               <div class="ack-box">
                  <h4>Context Update Acknowledgement</h4>
                  <pre>{{ state.acknowledgement_round_2 }}</pre>
               </div>
               <form method="post" style="text-align:center; margin-top: 24px;">
                  <button type="submit" name="action" value="continue_after_r2">
                  Continue
                  </button>
               </form>
               {% endif %}
            </section>
            <!-- ===================================================== -->
            <!-- STEP 7 ‚Äî Optional Critique Round 3 (Framework Selection) -->
            <!-- ===================================================== -->
            {% if state.current_step >= 7 %}
            <section id="step-5" class="step">
               <h2>Optional ‚Äî Critique Round 3</h2>
               <div id="step-5-select"></div>
               <p>Select 1 to 3 frameworks for a final critique round.</p>
               <form method="post">
                  <h3>Select 1‚Äì3 frameworks</h3>
                  <select name="selected_frameworks" multiple size="6" style="width:100%;">
                  {% for fw in state.available_frameworks %}
                  <option value="{{ fw }}"
                  {% if fw in state.get("user_selected_frameworks", []) %}
                  selected
                  {% endif %}
                  >
                  {{ fw }}
                  </option>
                  {% endfor %}
                  </select>
                  <div style="margin-top:16px;">
                     <button type="submit" name="action" value="run_round_3">
                     Run Critique Round 3
                     </button>
                     <button type="submit" name="action" value="skip_round_3">
                     üöÄ Skip Final Critique
                     </button>
                  </div>
               </form>
               {% endif %}
               <!-- ===================================================== -->
               <!-- STEP 8 ‚Äî Critique Round 3 -->
               <!-- ===================================================== -->
               {% if state.current_step >= 8 %}
               <h2>Critique Round 3</h2>
               <div id="step-5-critique"></div>
               <div class="critique-grid">
                  <!-- LEFT: Critique Output -->
                  <div class="critique-box">
                     <h3>Critique</h3>
                     <div class="critique-content">
                        {{ state.critique_round_3 }}
                     </div>
                  </div>
                  <!-- RIGHT: User Responses -->
                  <div class="critique-responses">
                     <h3>Your Responses</h3>
                     <p>Respond to each framework (type '-' if none).</p>
                     <form method="post">
                        {% for fw in state.user_selected_frameworks %}
                        <div class="clarification-item">
                           <div class="fixed-label">
                              üí¨ {{ fw }}
                           </div>
                           <textarea
                              name="critique_response_r3_{{ loop.index0 }}"
                              rows="6"
                              >{{ state["critique_response_r3_" ~ loop.index0] or "" }}</textarea>
                        </div>
                        {% endfor %}
                        <button type="submit">
                        Submit Your Reflections (Round 3)
                        </button>
                     </form>
                  </div>
               </div>
               {% endif %}
               <!-- ===================================================== -->
               <!-- STEP 9 ‚Äî Context Update Acknowledgement (Round 3) -->
               <!-- ===================================================== -->
               {% if state.current_step >= 9 %}
               <div id="step-5-ack"></div>
               <div class="ack-box">
                  <h4>Context Update Acknowledgement</h4>
                  <pre>{{ state.acknowledgement_round_3 }}</pre>
               </div>
               <form method="post" style="text-align:center; margin-top: 24px;">
                  <button type="submit">
                  Continue to Aggregated Summary
                  </button>
               </form>
               {% endif %}
            </section>
            <!-- ===================================================== -->
            <!-- STEP 10 ‚Äî AGGREGATED CRITIQUE SUMMARY -->
            <!-- ===================================================== -->
            {% if state.current_step >= 10 %}
            <section id="step-6" class="step">
               <h2>Aggregated Critique Summary & Criticality Ranking</h2>
               <form method="post">
                  <button type="submit" name="action" value="run_synthesis">
                  Generate Aggregated Critique Summary
                  </button>
               </form>
               {% if state.critique_synthesis %}
               <div class="critique-box" style="margin-top: 30px;">
                  <h3>üß† Aggregated Critique Summary</h3>
                  <div class="critique-content">
                     {{ state.critique_synthesis }}
                  </div>
               </div>
               <form method="post" style="margin-top: 24px; text-align:center;">
                  <button type="submit" name="action" value="continue_to_mitigations">
                  Continue to Mitigations
                  </button>
               </form>
               {% endif %}
               {% endif %}
            </section>
            <!-- ===================================================== -->
            <!-- STEP 11 ‚Äî MITIGATION & IMPROVEMENT IDEAS -->
            <!-- ===================================================== -->
            {% if state.current_step >= 11 %}
            <section id="step-7" class="step">
               <h2>Mitigation & Improvement Ideas</h2>
               <form method="post">
                  <button type="submit" name="action" value="run_mitigations">
                  Generate Mitigations & Improvements
                  </button>
               </form>
               {% if state.mitigation_improvement_output %}
               <div class="critique-box" style="margin-top: 30px;">
                  <h3>üõ†Ô∏è Mitigations & Improvements</h3>
                  <div class="critique-content">
                     {{ state.mitigation_improvement_output }}
                  </div>
               </div>
               <form method="post" style="margin-top: 24px; text-align:center;">
                  <button type="submit" name="action" value="continue_to_context_prompt">
                  Generate Context Prompt
                  </button>
               </form>
               {% endif %}
               {% endif %}
            </section>
            <!-- ===================================================== -->
            <!-- STEP 12 ‚Äî CONTEXT-SETTING PROMPT -->
            <!-- ===================================================== -->
            {% if state.current_step >= 12 %}
            <section id="step-8" class="step">
               <h2>Context-Setting Prompt</h2>
               <form method="post">
                  <button type="submit" name="action" value="generate_context_prompt">
                  Generate Context Prompt
                  </button>
               </form>
               {% if state.context_prompt %}
               <div class="critique-box" style="margin-top: 30px;">
                  <h3>üìå Context Prompt</h3>
                  <div class="critique-content">
                     {{ state.context_prompt }}
                  </div>
               </div>
               <form method="post" style="margin-top: 30px; text-align:center;">
                  <button type="submit" name="action" value="reset_app">
                  Challenge Another Idea
                  </button>
               </form>
               {% endif %}
               {% endif %}
            </section>
            <!-- ===================================================== -->
            <!-- STEP 13 ‚Äî THANK YOU / RESET -->
            <!-- ===================================================== -->
            {% if state.current_step >= 13 %}
            <div id="step-9"></div>
            <h2>Thanks for using ReInventor üôå</h2>
            <p>
               Your idea has been stress-tested, refined, and equipped with concrete
               mitigations.  
               You‚Äôre now ready to move forward with confidence.
            </p>
            <form method="post" style="margin-top: 30px; text-align:center;">
               <button type="submit" name="action" value="reset_app">
               Start a New Challenge
               </button>
            </form>
            {% endif %}


            <script>
            document.addEventListener("DOMContentLoaded", () => {
               const id = "{{ scroll_to }}";
               const el = document.getElementById(id);
               const scroller = document.querySelector(".main-content");
               if (!el || !scroller) return;

               const offset = 80;

               // el.offsetTop is relative to the whole document; we need relative to the scroll container
               const targetTop = el.getBoundingClientRect().top - scroller.getBoundingClientRect().top + scroller.scrollTop;

               scroller.scrollTo({
                  top: Math.max(0, targetTop - offset),
                  behavior: "smooth"
               });
            });
            </script>

            <script>
            document.addEventListener("DOMContentLoaded", () => {
               const track = document.querySelector(".progress-track");
               if (!track) return;

               const fill = track.querySelector(".progress-fill");
               if (!fill) return;

               const pct = parseFloat(track.getAttribute("data-progress") || "0");
               fill.style.width = pct + "%";
            });
            </script>




         </div>
      </main>
   </body>
</html>