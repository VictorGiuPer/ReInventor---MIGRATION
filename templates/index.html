<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <title>ReInventor (Flask)</title>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
      <style>
         * { margin: 0; padding: 0; box-sizing: border-box; }
         body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #111937;
            color: #FFFFFF;
            line-height: 1.6;
            min-height: 100vh;
         }
         h1 { font-size: 32px; font-weight: 700; color: #FFFFFF; margin-bottom: 8px; letter-spacing: -0.5px; }
         h2 { font-size: 24px; font-weight: 600; color: #FFFFFF; margin-top: 40px; margin-bottom: 20px; letter-spacing: -0.3px; }
         h3 { font-size: 18px; font-weight: 600; color: #FFFFFF; margin-bottom: 12px; }
         h4 { font-size: 15px; font-weight: 600; color: #FFFFFF; margin-bottom: 8px; }
         p  { margin-bottom: 16px; color: #FFFFFF; }

         /* ============================= */
         /* FORM ELEMENTS                 */
         /* ============================= */
         label { display: block; font-weight: 500; font-size: 14px; color: #FFFFFF; margin-bottom: 8px; }
         input[type="text"], input[type="number"], textarea, select {
            width: 100%; padding: 12px 16px; font-size: 15px;
            color: #FFFFFF; background-color: rgba(191,191,191,0.4);
            border: 1px solid rgba(255,255,255,0.6); border-radius: 8px;
            margin-bottom: 20px; font-family: inherit; transition: all 0.2s ease;
         }
         input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: none; border-color: #00D5D0; box-shadow: 0 0 0 2px rgba(0,213,208,0.35);
         }
         textarea { resize: vertical; min-height: 100px; }
         select[multiple] { padding: 8px; min-height: 200px; }
         select[multiple] option { padding: 8px 12px; border-radius: 4px; margin-bottom: 4px; }

         /* ============================= */
         /* BUTTONS                       */
         /* ============================= */
         button {
            padding: 12px 24px; font-size: 15px; font-weight: 600;
            color: #FFFFFF; background-color: #2563EB;
            border: none; border-radius: 8px; cursor: pointer;
            transition: all 0.2s ease; font-family: inherit;
         }
         button:hover { background-color: #1d4ed8; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
         button:active { transform: translateY(0); }
         button[name="action"][value="skip_round_3"] {
            background-color: #F5F7FA; color: #111827; border: 2px solid #D1D5DB; margin-left: 12px;
         }
         button[name="action"][value="skip_round_3"]:hover {
            background-color: #EFF6FF; border-color: #60A5FA; transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(96,165,250,0.2);
         }

         /* ============================= */
         /* FORMS                         */
         /* ============================= */
         form { background: transparent; padding: 0; border: none; margin-top: 16px; }
         form.bordered { padding: 32px; border-radius: 12px; border: 1px solid #FFFFFF; margin-top: 24px; }
         form button[type="submit"] { margin-top: 8px; }
         form.action-form { border: none; padding: 0; text-align: center; margin-top: 24px; }

         /* ============================= */
         /* WARNING / SUCCESS             */
         /* ============================= */
         .warning { background: #FEF2F2; padding: 16px 20px; border-left: 4px solid #DC2626; border-radius: 8px; margin-bottom: 24px; color: #991B1B; font-weight: 500; }

         /* ============================= */
         /* CLARIFICATION                 */
         /* ============================= */
         .clarification-box { background: #EFF6FF; padding: 24px; margin-bottom: 32px; border-radius: 12px; border: 2px solid #60A5FA; }
         .clarification-box h3 { color: #111827; margin-bottom: 12px; }
         .clarification-box p  { color: #111827; line-height: 1.7; }
         .clarification-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px 28px; margin-top: 24px; margin-bottom: 20px; }
         .clarification-item { display: flex; flex-direction: column; justify-content: flex-end; }
         .fixed-label { font-weight: 600; margin-bottom: 8px; line-height: 1.4; color: #FFFFFF; font-size: 14px; }

         /* ============================= */
         /* CRITIQUE GRID                 */
         /* Left: 60% critique (scrollable)*/
         /* Right: 40% responses + ack     */
         /* ============================= */
         .critique-grid {
            display: grid;
            grid-template-columns: 6fr 4fr;  /* 60:40 split */
            gap: 32px;
            margin: 24px 0;
            align-items: start;
         }

         /* Critique panels ‚Äî fixed height, scrollable */
         .critique-box {
            background: #F5F7FA;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #D1D5DB;
            max-height: 110vh;
            overflow-y: auto;
         }
         .critique-box.output-box { max-width: 900px; margin-left: auto; margin-right: auto; }
         .critique-box h3 {
            color: #111827;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #D1D5DB;
         }
         .output-box-header {
            display: flex; align-items: center; justify-content: space-between;
            padding-bottom: 12px; margin-bottom: 16px; border-bottom: 2px solid #D1D5DB;
         }
         .output-box-header h3 { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
         .copy-btn {
            padding: 5px 14px; font-size: 12px; font-weight: 600;
            background: #FFFFFF; color: #374151;
            border: 1px solid #D1D5DB; border-radius: 6px;
            cursor: pointer; transition: all 0.15s ease; flex-shrink: 0;
         }
         .copy-btn:hover { background: #EFF6FF; border-color: #60A5FA; transform: none; box-shadow: none; }
         .copy-btn.copied { background: #ECFDF5; border-color: #10B981; color: #059669; }

         /* LLM output content ‚Äî no scroll here, parent handles it */
         .critique-content {
            line-height: 1.7;
            color: #111827;
            white-space: normal;
         }
         .critique-content h1, .critique-content h2, .critique-content h3,
         .critique-content h4, .critique-content h5 {
            color: #111827; margin-top: 1.2em; margin-bottom: 0.5em; font-weight: 700; line-height: 1.3;
         }
         .critique-content h1 { font-size: 1.25em; }
         .critique-content h2 { font-size: 1.15em; margin-top: 1.4em; }
         .critique-content h3 { font-size: 1.05em; }
         .critique-content h4 { font-size: 0.95em; }
         .critique-content p  { color: #111827; margin-bottom: 0.8em; }
         .critique-content ul, .critique-content ol { color: #111827; padding-left: 1.4em; margin-bottom: 0.8em; }
         .critique-content li { margin-bottom: 0.3em; }
         .critique-content strong { font-weight: 700; color: #111827; }
         .critique-content em { font-style: italic; }
         .critique-content hr { border: none; border-top: 1px solid #D1D5DB; margin: 1em 0; }
         .critique-content code { background: #E5E7EB; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; font-family: 'SF Mono', Menlo, monospace; color: #111827; }
         .critique-content blockquote { border-left: 3px solid #60A5FA; margin: 0.8em 0; padding: 4px 16px; color: #374151; }

         /* Scrollbar for critique box */
         .critique-box::-webkit-scrollbar { width: 8px; }
         .critique-box::-webkit-scrollbar-track { background: #F5F7FA; border-radius: 4px; }
         .critique-box::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 4px; }
         .critique-box::-webkit-scrollbar-thumb:hover { background: #60A5FA; }

         /* RIGHT column ‚Äî just the response form, ack moved outside grid */
         .critique-responses {
            display: flex;
            flex-direction: column;
         }
         .critique-responses h3  { margin-bottom: 8px; }
         .critique-responses > p { font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 16px; }
         .critique-responses .clarification-item { margin-bottom: 16px; }
         .critique-responses textarea { margin-bottom: 0; min-height: 150px; }
         .critique-responses form { padding: 0; border: none; background: transparent; margin-top: 0; }

         /* Standalone ack block ‚Äî below grid, not full-width */
         .critique-ack-standalone {
            max-width: 900px;
            margin: 32px auto 0;
            padding: 24px;
            background: #EFF6FF;
            border-left: 4px solid #2563EB;
            border-radius: 12px;
         }
         .critique-ack-standalone h4 { color: #1E40AF; margin-bottom: 12px; font-size: 16px; font-weight: 600; }

         /* ============================= */
         /* ACK CONTENT (markdown)        */
         /* ============================= */
         .ack-content { white-space: normal; font-family: inherit; line-height: 1.7; color: #111827; }
         .ack-content h1, .ack-content h2, .ack-content h3 { color: #111827; font-weight: 700; margin-top: 1em; margin-bottom: 0.4em; }
         .ack-content p  { color: #111827; margin-bottom: 0.6em; }
         .ack-content ul, .ack-content ol { color: #111827; padding-left: 1.4em; margin-bottom: 0.6em; }
         .ack-content li { margin-bottom: 0.25em; }
         .ack-content strong { font-weight: 700; }

         /* ============================= */
         /* REFRAMED UNDERSTANDING        */
         /* ============================= */
         .reframed-content { color: #111827; line-height: 1.7; }
         .reframed-content p      { color: #111827; margin-bottom: 0.6em; }
         .reframed-content strong { font-weight: 700; }
         .reframed-content ul     { color: #111827; padding-left: 1.4em; margin-bottom: 0.6em; }

         /* ============================= */
         /* APP LAYOUT                    */
         /* ============================= */
         .app-layout { display: flex; }
         .sidebar {
            position: fixed; top: 0; left: 0; width: 220px; height: 100vh;
            background-color: #F2F2F2; display: flex; flex-direction: column;
            z-index: 100; border-top-right-radius: 6px; border-bottom-right-radius: 6px; overflow: hidden;
         }
         .main-content {
            margin-left: 220px; flex: 1; height: 100vh; overflow-y: auto;
            padding: 40px 24px; background-color: transparent;
         }

         /* ============================= */
         /* SIDEBAR                       */
         /* ============================= */
         .sidebar-inner { display: flex; flex-direction: column; padding: 12px 14px; gap: 16px; flex: 1; }
         .sidebar-feedback { margin-top: auto; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.12); }
         .feedback-link {
            display: block; text-align: center; padding: 8px 12px; margin-bottom: 10px;
            background: rgba(0,213,208,0.12); color: #111937;
            border: 1px solid rgba(0,213,208,0.45); border-radius: 6px;
            font-size: 13px; font-weight: 600; text-decoration: none; transition: background 0.15s;
         }
         .feedback-link:hover { background: rgba(0,213,208,0.25); }
         .feedback-note { font-size: 11px; color: #6B7280; text-align: center; line-height: 1.6; margin: 0; }
         .step-end-actions { display: flex; gap: 12px; align-items: center; justify-content: center; flex-wrap: wrap; margin-top: 24px; }
         .step-end-actions form.action-form { margin-top: 0; }
         .feedback-btn-inline {
            display: inline-block; padding: 12px 24px; font-size: 15px; font-weight: 600;
            color: #2563EB; background-color: transparent;
            border: 2px solid #2563EB; border-radius: 8px;
            text-decoration: none; cursor: pointer; transition: all 0.2s ease;
         }
         .feedback-btn-inline:hover { background-color: rgba(37,99,235,0.07); transform: translateY(-1px); }
         .next-steps-intro { max-width: 560px; margin: 0 auto 50px; color: #ffffff; font-size: 16px; line-height: 1.7; text-align: center; }
         .next-steps-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
         .next-step-card { background: #F5F7FA; border: 1px solid #D1D5DB; border-radius: 12px; padding: 24px; display: flex; flex-direction: column; gap: 16px; }
         .next-step-card h3 { font-size: 16px; color: #111827; margin: 0; }
         .next-step-card-body { flex: 1; display: flex; flex-direction: column; gap: 8px; }
         .next-step-card-body p { font-size: 14px; color: #6B7280; line-height: 1.5; margin: 0; }
         .next-step-card form { margin: 0; }
         .next-step-card button { width: 100%; }
         .next-step-btn { display: block; padding: 12px 24px; font-size: 15px; font-weight: 600; color: #FFFFFF; background-color: #2563EB; border-radius: 8px; text-decoration: none; text-align: center; transition: all 0.2s ease; }
         .next-step-btn:hover { background-color: #1d4ed8; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
         .sidebar-gradient { height: 24px; background: linear-gradient(90deg, #111937 0%, #0057AB 30%, #1DB6F3 70%, #00D5D0 100%); }
         .sidebar-logo { display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 0 0 6px; }
         .company-logo { height: 60px; width: auto; display: block; }
         .tool-name { font-size: 15px; font-weight: 700; color: #111937; line-height: 1; letter-spacing: 0.2px; }
         .sidebar-progress { display: flex; flex-direction: column; gap: 6px; }
         .progress-label { font-size: 13px; font-weight: 600; color: #111937; }
         .progress-track { height: 6px; background-color: #E5E7EB; border-radius: 4px; overflow: hidden; }
         .progress-fill  { height: 100%; width: 0%; background-color: #00D5D0; transition: width 0.4s ease; }
         .sidebar-nav { display: flex; flex-direction: column; gap: 3px; }
         .sidebar-nav a { padding: 6px 10px; font-size: 13px; color: #111937; text-decoration: none; border-radius: 6px; }
         .sidebar-nav a:hover { background-color: rgba(0,0,0,0.05); }
         .sidebar-nav a.active { background-color: rgba(0,213,208,0.2); font-weight: 600; }
         .sidebar-nav a.done { opacity: 0.75; }
         .sidebar-nav a.done::before { content: "‚úì "; font-weight: 700; color: #00D5D0; }

         /* ============================= */
         /* STEP 1 IDEA GRID              */
         /* ============================= */
         .idea-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
         .form-group { display: flex; flex-direction: column; }
         .stacked-right { display: flex; flex-direction: column; gap: 0; }
         .textarea-large  { min-height: 180px; }
         .textarea-medium { min-height: 140px; }
         .textarea-small  { min-height: 70px; }

         /* ============================= */
         /* FRAMEWORK CHECKBOX GRID      */
         /* ============================= */
         .fw-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 8px 16px; margin: 16px 0 24px;
         }
         label.fw-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 12px; border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.05);
            cursor: pointer; margin-bottom: 0; font-weight: 400;
            transition: background 0.15s, border-color 0.15s;
         }
         label.fw-item:hover { background: rgba(255,255,255,0.1); }
         label.fw-item:has(input:checked) {
            background: rgba(0,213,208,0.12); border-color: #00D5D0;
         }
         label.fw-item input[type="checkbox"] {
            width: 16px; height: 16px; flex-shrink: 0;
            accent-color: #00D5D0; cursor: pointer; margin-bottom: 0;
         }
         .fw-name { flex: 1; font-size: 14px; color: #FFFFFF; }
         @media (max-width: 900px) { .fw-grid { grid-template-columns: 1fr; } }

         /* ============================= */
         /* ABSTRACTION SLIDER           */
         /* ============================= */
         .slider-row {
            display: flex; align-items: center; gap: 10px; margin-bottom: 20px;
         }
         .slider-row input[type="range"] { flex: 1; margin-bottom: 0; }
         .slider-value {
            font-size: 18px; font-weight: 700; color: #00D5D0;
            min-width: 24px; text-align: center;
         }
         .slider-label { font-size: 12px; color: rgba(255,255,255,0.5); white-space: nowrap; }
         .slider-label-row {
            display: flex; align-items: center; gap: 6px;
            font-weight: 500; font-size: 14px; color: #FFFFFF; margin-bottom: 8px;
         }
         .info-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 16px; height: 16px; border-radius: 50%;
            background: rgba(255,255,255,0.2); color: #FFFFFF;
            font-size: 11px; font-weight: 700; cursor: default;
            position: relative; flex-shrink: 0; line-height: 1;
         }
         .info-icon .tooltip {
            display: none; position: absolute; top: 50%; right: calc(100% + 8px);
            transform: translateY(-50%);
            background: #1E293B; color: rgba(255,255,255,0.85);
            font-size: 13px; font-weight: 400; line-height: 1.5;
            padding: 10px 14px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.15);
            width: 300px; white-space: normal; z-index: 200;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
         }
         .info-icon .tooltip::after {
            content: ""; position: absolute; top: 50%; left: 100%;
            transform: translateY(-50%);
            border: 6px solid transparent; border-left-color: #1E293B;
         }
         .info-icon:hover .tooltip { display: block; }

         /* ============================= */
         /* LOADING SHIMMER               */
         /* ============================= */
         button[type="submit"] { position: relative; overflow: hidden; }
         button[type="submit"].loading { pointer-events: none; opacity: 0.85; }
         button[type="submit"]::after {
            content: ""; position: absolute; top: 0; left: -150%; width: 50%; height: 100%;
            background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,0.45) 50%, transparent 100%);
         }
         button[type="submit"].loading::after { animation: shimmer 1.4s infinite; }
         @keyframes shimmer { 0% { left: -150%; } 100% { left: 150%; } }

         /* ============================= */
         /* UTILITY                       */
         /* ============================= */
         .mt-4 { margin-top: 16px; }
         .mt-6 { margin-top: 24px; }

         /* ============================= */
         /* RESPONSIVE                    */
         /* ============================= */
         @media (max-width: 900px) {
            .idea-grid          { grid-template-columns: 1fr; }
            .clarification-grid { grid-template-columns: 1fr; gap: 16px; }
            .critique-grid      { grid-template-columns: 1fr; gap: 20px; }
            .next-steps-grid    { grid-template-columns: 1fr; }
            h1 { font-size: 28px; } h2 { font-size: 22px; }
            form.bordered { padding: 20px; }
            button { width: 100%; margin-bottom: 12px; }
            button[name="action"][value="skip_round_3"] { margin-left: 0; }
         }

         h1.hero {
            background: linear-gradient(90deg, #FFFFFF 0%, #1DB6F3 50%, #00D5D0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 38px;
         }
         .slider-row {
            display: flex; align-items: center; gap: 10px;
         }
         .slider-row input[type="range"] { flex: 1; margin-bottom: 0; }
         .slider-value {
            font-size: 18px; font-weight: 700; color: #00D5D0;
            min-width: 24px; text-align: center;
         }
         .slider-label { font-size: 12px; color: rgba(255,255,255,0.5); white-space: nowrap; }

      </style>
   </head>
   <body>
      <div class="app-layout">

      <!-- ===================== -->
      <!-- SIDEBAR               -->
      <!-- ===================== -->
      <aside class="sidebar">
         <div class="sidebar-gradient"></div>
         <div class="sidebar-inner">
            {% set cs = state.get("current_step", 0) %}
            {% if cs <= 0 %}{% set ui_step = 1 %}
            {% elif cs <= 2 %}{% set ui_step = 2 %}
            {% elif cs <= 4 %}{% set ui_step = 3 %}
            {% elif cs <= 6 %}{% set ui_step = 4 %}
            {% elif cs <= 9 %}{% set ui_step = 5 %}
            {% elif cs <= 10 %}{% set ui_step = 6 %}
            {% elif cs <= 11 %}{% set ui_step = 7 %}
            {% else %}{% set ui_step = 8 %}
            {% endif %}
            {% set progress_pct = ui_step * 12.5 %}

            <div class="sidebar-logo">
               <img src="{{ url_for('static', filename='invent_logo.png') }}" alt="Company logo" class="company-logo">
            </div>
            <div class="sidebar-progress">
               <span class="progress-label">Progress</span>
               <div class="progress-track" data-progress="{{ progress_pct }}">
                  <div class="progress-fill"></div>
               </div>
            </div>
            <nav class="sidebar-nav">
               <a href="#step-1" class="{% if ui_step == 1 %}active{% elif ui_step > 1 %}done{% endif %}">1. Submit Idea</a>
               <a href="#step-2" class="{% if ui_step == 2 %}active{% elif ui_step > 2 %}done{% endif %}">2. Clarify</a>
               <a href="#step-3" class="{% if ui_step == 3 %}active{% elif ui_step > 3 %}done{% endif %}">3. Critique 1</a>
               <a href="#step-4" class="{% if ui_step == 4 %}active{% elif ui_step > 4 %}done{% endif %}">4. Critique 2</a>
               <a href="#step-5" class="{% if ui_step == 5 %}active{% elif ui_step > 5 %}done{% endif %}">5. Critique 3</a>
               <a href="#step-6" class="{% if ui_step == 6 %}active{% elif ui_step > 6 %}done{% endif %}">6. Synthesis</a>
               <a href="#step-7" class="{% if ui_step == 7 %}active{% elif ui_step > 7 %}done{% endif %}">7. Mitigations</a>
               <a href="#step-8" class="{% if ui_step == 8 %}active{% endif %}">8. Context Prompt</a>
            </nav>
            <div class="sidebar-feedback">
               <a href="https://forms.office.com/Pages/ResponsePage.aspx?id=Wq6idgCfa0-V7V0z13xNYfd32hYhLhBOg4iVrohHM35UMDU2Q1cxNzNGRkhNWkhZWjlERkc2WkxaNS4u" target="_blank" class="feedback-link">Give Feedback</a>
               <p class="feedback-note">Questions or suggestions?<br>Reach out to <strong>Victor Giustini Perez</strong>.</p>
            </div>
         </div>
      </aside>

      <!-- ===================== -->
      <!-- MAIN CONTENT          -->
      <!-- ===================== -->
      <main class="main-content">
         <div class="content-card">
            <h1 class="hero">ReInventor</h1>
            <p class="tagline">Stress-test your idea before the others do.</p>

            {% if message %}<div class="warning">{{ message }}</div>{% endif %}

            <!-- ================================================= -->
            <!-- STEP 1 ‚Äî SUBMIT IDEA                              -->
            <!-- ================================================= -->
            {% if state.current_step >= 0 %}
            <section id="step-1" class="step">
               <h2>Submit Your Idea</h2>
               <form method="post" class="bordered">
                  <div class="idea-grid">
                     <div class="form-group">
                        <label><strong>Problem</strong></label>
                        <textarea name="problem" class="textarea-large">{{ state.problem or "" }}</textarea>
                     </div>
                     <div class="form-group">
                        <label><strong>Proposed Approach</strong></label>
                        <textarea name="approach" class="textarea-large">{{ state.approach or "" }}</textarea>
                     </div>
                     <div class="form-group">
                        <label><strong>Primary Stakeholder</strong></label>
                        <textarea name="stakeholder" class="textarea-medium">{{ state.stakeholder or "" }}</textarea>
                     </div>
                     <div class="form-group stacked-right">
                        <div class="form-group">
                           <label><strong>Constraints / Non-negotiables</strong></label>
                           <textarea name="constraints" class="textarea-small">{{ state.constraints or "" }}</textarea>
                        </div>
                        <div class="form-group">
                           <div class="slider-label-row">
                              <strong>Critique abstraction level</strong>
                              <span class="info-icon">i
                                 <span class="tooltip">Choose the <em>kind</em> of critique most useful to you. <strong>0 = very practical</strong> (e.g., management, operations) ‚Äî grounded but potentially narrower. <strong>10 = more abstract</strong> (e.g., logic, philosophy) ‚Äî broader but higher-level.</span>
                              </span>
                           </div>
                           <div class="slider-row">
                              <span class="slider-label">Practical</span>
                              <input type="range" name="abstraction" min="0" max="10"
                                    value="{{ state.abstraction or 5 }}"
                                    oninput="this.parentElement.querySelector('.slider-value').textContent = this.value">
                              <span class="slider-value">{{ state.abstraction or 5 }}</span>
                              <span class="slider-label">Abstract</span>
                           </div>
                        </div>
                     </div>
                  </div>
                  <button type="submit" name="action" value="submit_idea">Generate Clarifying Questions</button>
               </form>
            </section>
            {% endif %}

            <!-- ================================================= -->
            <!-- STEP 2 ‚Äî CLARIFY                                  -->
            <!-- ================================================= -->
            {% if state.current_step >= 1 %}
            <section id="step-2" class="step">
               <h2>Clarify and give more context</h2>
               <div id="step-2-questions"></div>
               <div class="clarification-box">
                  <h3>Reframed Understanding</h3>
                  <div class="reframed-content markdown-render">{{ state.reframed_understanding or "" }}</div>
               </div>
               <form method="post" class="bordered">
                  {% if state.get("clarification_prompts") %}
                  <div class="clarification-grid">
                     {% for i in range(3) %}
                     <div class="clarification-item">
                        <div class="fixed-label" title="{{ state.clarification_prompts[i] }}">{{ state.clarification_prompts[i] }}</div>
                        <textarea name="clarify_answer_{{ i }}" rows="5">{{ state["clarify_answer_" ~ i] or "" }}</textarea>
                     </div>
                     <div class="clarification-item">
                        <div class="fixed-label" title="{{ state.clarification_prompts[i+3] }}">{{ state.clarification_prompts[i+3] }}</div>
                        <textarea name="clarify_answer_{{ i+3 }}" rows="5">{{ state["clarify_answer_" ~ (i+3)] or "" }}</textarea>
                     </div>
                     {% endfor %}
                  </div>
                  {% endif %}
                  <button type="submit" name="action" value="update_summary">Generate Context Summary</button>
               </form>
               {% if state.current_step >= 2 %}
               <div id="step-2-summary"></div>
               <h3 class="mt-6">Context Summary</h3>
               <p>Review or edit the context summary below before continuing.</p>
               <form method="post" class="bordered">
                  <input type="hidden" name="action" value="run_critique_1">
                  <textarea name="context_summary" rows="14" style="width:100%;">{{ state.context_summary or "" }}</textarea>
                  <div style="margin-top:15px;">
                     <button type="submit">Run Critique Round 1</button>
                  </div>
               </form>
               {% endif %}
            </section>
            {% endif %}

            <!-- ================================================= -->
            <!-- STEP 3 ‚Äî CRITIQUE ROUND 1                        -->
            <!-- ===
            Left:  full-height critique output (no scroll)
            Right: response textareas on top, ack box below
            ================================================= -->
            {% if state.current_step >= 3 %}
            <section id="step-3" class="step">
               <h2>Critique Round 1</h2>
               <div id="step-3-critique"></div>
               <div class="critique-grid">

                  <!-- LEFT: LLM output, full natural height -->
                  <div class="critique-box">
                     <h3>Critique</h3>
                     <div class="critique-content markdown-render">{{ state.critique_round_1 or "" }}</div>
                  </div>

                  <!-- RIGHT: responses only -->
                  <div class="critique-responses">
                     <h3>Your Responses</h3>
                     <p>Respond to each framework (use '-' if nothing to add).</p>
                     {% if state.frameworks_used_round_1 %}
                     <form method="post">
                        {% for fw in state.frameworks_used_round_1 %}
                        <div class="clarification-item" style="margin-bottom:16px;">
                           <div class="fixed-label">üí¨ {{ fw }}</div>
                           <textarea name="critique_response_r1_{{ loop.index0 }}" rows="5">{{ state["critique_response_r1_" ~ loop.index0] or "" }}</textarea>
                        </div>
                        {% endfor %}
                        <button type="submit" name="action" value="submit_r1">Submit Your Reflections</button>
                     </form>
                     {% endif %}
                  </div><!-- /critique-responses -->

               </div><!-- /critique-grid -->

               {% if state.current_step >= 4 %}
               <!-- ACK below grid -->
               <div id="step-3-ack" class="critique-ack-standalone">
                  <h4>Context Update Acknowledgement</h4>
                  <div class="ack-content markdown-render">{{ state.acknowledgement_round_1 or "" }}</div>
               </div>
               {% endif %}

               {% if state.current_step >= 4 %}
               <form method="post" class="action-form">
                  <button type="submit" name="action" value="run_critique_2">Run Critique Round 2</button>
               </form>
               {% endif %}
            </section>
            {% endif %}

            <!-- ================================================= -->
            <!-- STEP 5 ‚Äî CRITIQUE ROUND 2                        -->
            <!-- ================================================= -->
            {% if state.current_step >= 5 %}
            <section id="step-4" class="step">
               <h2>Critique Round 2</h2>
               <div id="step-4-critique"></div>
               <div class="critique-grid">

                  <div class="critique-box">
                     <h3>Critique</h3>
                     <div class="critique-content markdown-render">{{ state.critique_round_2 or "" }}</div>
                  </div>

                  <div class="critique-responses">
                     <h3>Your Responses</h3>
                     <p>Respond to each framework (use '-' if nothing to add).</p>
                     <form method="post">
                        {% for fw in state.frameworks_used_round_2 %}
                        <div class="clarification-item" style="margin-bottom:16px;">
                           <div class="fixed-label">üí¨ {{ fw }}</div>
                           <textarea name="critique_response_r2_{{ loop.index0 }}" rows="5">{{ state["critique_response_r2_" ~ loop.index0] or "" }}</textarea>
                        </div>
                        {% endfor %}
                        <button type="submit" name="action" value="submit_r2">Submit Your Reflections (Round 2)</button>
                     </form>
                  </div><!-- /critique-responses -->

               </div><!-- /critique-grid -->
               {% endif %}

               {% if state.current_step >= 6 %}
               <div id="step-4-ack" class="critique-ack-standalone">
                  <h4>Context Update Acknowledgement</h4>
                  <div class="ack-content markdown-render">{{ state.acknowledgement_round_2 or "" }}</div>
               </div>
               {% endif %}
            </section>

            <!-- ================================================= -->
            <!-- STEP 7 ‚Äî OPTIONAL CRITIQUE ROUND 3               -->
            <!-- ================================================= -->
            {% if state.current_step >= 7 and not state.get("done_round_3") %}
            <section id="step-5" class="step">
               <h2>Optional ‚Äî Critique Round 3</h2>
               <div id="step-5-select"></div>
               <p>Select 1 to 3 frameworks for a final critique round.</p>
               <form method="post" class="bordered">
                  <h3>Select 1‚Äì3 frameworks</h3>
                  <p style="font-size:14px; color:rgba(255,255,255,0.6); margin-bottom:4px;">Hover the <strong>i</strong> to read what each framework does.</p>
                  <div class="fw-grid">
                     {% for fw in state.available_frameworks %}
                     <label class="fw-item">
                        <input type="checkbox" name="selected_frameworks" value="{{ fw.name }}"
                               {% if fw.name in state.get("user_selected_frameworks", []) %}checked{% endif %}>
                        <span class="fw-name">{{ fw.name }}</span>
                        <span class="info-icon">i
                           <span class="tooltip">{{ fw.tooltip }}</span>
                        </span>
                     </label>
                     {% endfor %}
                  </div>
                  <div style="margin-top:8px;">
                     <button type="submit" name="action" value="run_round_3">Run Critique Round 3</button>
                     <button type="submit" name="action" value="skip_round_3">üöÄ Skip Final Critique</button>
                  </div>
               </form>
            {% endif %}

               {% if state.critique_round_3 %}
               <h2>Critique Round 3</h2>
               <div id="step-5-critique"></div>
               <div class="critique-grid">

                  <div class="critique-box">
                     <h3>Critique</h3>
                     <div class="critique-content markdown-render">{{ state.critique_round_3 or "" }}</div>
                  </div>

                  <div class="critique-responses">
                     <h3>Your Responses</h3>
                     <p>Respond to each framework (use '-' if nothing to add).</p>
                     <form method="post">
                        {% for fw in state.user_selected_frameworks %}
                        <div class="clarification-item" style="margin-bottom:16px;">
                           <div class="fixed-label">üí¨ {{ fw }}</div>
                           <textarea name="critique_response_r3_{{ loop.index0 }}" rows="5">{{ state["critique_response_r3_" ~ loop.index0] or "" }}</textarea>
                        </div>
                        {% endfor %}
                        <button type="submit" name="action" value="submit_r3">Submit Your Reflections (Round 3)</button>
                     </form>
                  </div><!-- /critique-responses -->

               </div><!-- /critique-grid -->

               {% if state.acknowledgement_round_3 %}
               <div id="step-5-ack" class="critique-ack-standalone">
                  <h4>Context Update Acknowledgement</h4>
                  <div class="ack-content markdown-render">{{ state.acknowledgement_round_3 or "" }}</div>
               </div>
               {% endif %}
               {% endif %}
            </section>

            <!-- ================================================= -->
            <!-- STEP 10 ‚Äî SYNTHESIS                               -->
            <!-- ================================================= -->
            {% if state.current_step >= 10 %}
            <section id="step-6" class="step">
               <h2>Aggregated Critique Summary &amp; Criticality Ranking</h2>
               <form method="post" class="action-form">
                  <button type="submit" name="action" value="run_synthesis">Generate Aggregated Critique Summary</button>
               </form>
               {% if state.critique_synthesis %}
               <div class="critique-box output-box" style="margin-top:30px;">
                  <h3>üß† Aggregated Critique Summary</h3>
                  <div class="critique-content markdown-render">{{ state.critique_synthesis or "" }}</div>
               </div>
               {% endif %}
            </section>
            {% endif %}

            <!-- ================================================= -->
            <!-- STEP 11 ‚Äî MITIGATIONS                             -->
            <!-- ================================================= -->
            {% if state.current_step >= 11 %}
            <section id="step-7" class="step">
               <h2>Mitigation &amp; Improvement Ideas</h2>
               <form method="post" class="action-form">
                  <button type="submit" name="action" value="run_mitigations">Generate Mitigations &amp; Improvements</button>
               </form>
               {% if state.mitigation_improvement_output %}
               <div class="critique-box output-box" style="margin-top:30px;">
                  <h3>üõ†Ô∏è Mitigations &amp; Improvements</h3>
                  <div class="critique-content markdown-render">{{ state.mitigation_improvement_output or "" }}</div>
               </div>
               {% endif %}
            </section>
            {% endif %}

            <!-- ================================================= -->
            <!-- STEP 12 ‚Äî CONTEXT PROMPT                          -->
            <!-- ================================================= -->
            {% if state.current_step >= 12 %}
            <section id="step-8" class="step">
               <h2>Next Steps</h2>
               <h3 class="next-steps-intro">Thank you for using ReInventor ‚Äî this is the end of the process. Transfer your hardened idea to an LLM of your choice using the context prompt, or share your experience to help us improve.</h3>
               <div class="next-steps-grid">
                  <div class="next-step-card">
                     <div class="next-step-card-body">
                        <h3>üìã Context Prompt</h3>
                        <p>Generate a context-setting prompt that packages your idea, all critique rounds, and your reflections into a format ready to paste into any LLM.</p>
                     </div>
                     <form method="post">
                        <button type="submit" name="action" value="generate_context_prompt">Generate Prompt</button>
                     </form>
                  </div>
                  <div class="next-step-card">
                     <div class="next-step-card-body">
                        <h3>üí¨ Give Feedback</h3>
                        <p>Share your experience and help us improve ReInventor for future users. It takes less than 2 minutes.</p>
                     </div>
                     <a href="https://forms.office.com/Pages/ResponsePage.aspx?id=Wq6idgCfa0-V7V0z13xNYfd32hYhLhBOg4iVrohHM35UMDU2Q1cxNzNGRkhNWkhZWjlERkc2WkxaNS4u" target="_blank" class="next-step-btn">Give Feedback</a>
                  </div>
               </div>
               {% if state.context_prompt %}
               <textarea id="context-prompt-raw" style="display:none;">{{ state.context_prompt }}</textarea>
               <div class="critique-box output-box" style="margin-top:30px;">
                  <div class="output-box-header">
                     <h3>üìå Context Prompt</h3>
                     <button type="button" class="copy-btn" onclick="copyContextPrompt(this)">Copy</button>
                  </div>
                  <div class="critique-content markdown-render">{{ state.context_prompt or "" }}</div>
               </div>
               <form method="post" class="action-form" style="margin-top:30px;">
                  <button type="submit" name="action" value="reset_app">Challenge Another Idea</button>
               </form>
               {% endif %}
            </section>
            {% endif %}

         </div>
      </main>
      </div>

   <!-- ================================================= -->
   <!-- SCRIPTS                                           -->
   <!-- ================================================= -->
   <script>
   document.addEventListener("DOMContentLoaded", () => {
      if (typeof marked === "undefined") return;
      marked.setOptions({ breaks: true, gfm: true });
      document.querySelectorAll(".markdown-render").forEach(el => {
         const raw = el.textContent || el.innerText;
         if (raw.trim()) el.innerHTML = marked.parse(raw);
      });
   });
   </script>

   <script>
   (() => {
      const KEY = "scrollTopBeforeSubmit";
      document.addEventListener("submit", () => {
         const s = document.querySelector(".main-content");
         if (s) sessionStorage.setItem(KEY, String(s.scrollTop));
      }, true);
      document.addEventListener("DOMContentLoaded", () => {
         const s = document.querySelector(".main-content");
         if (!s) return;
         const prev = parseInt(sessionStorage.getItem(KEY) || "0", 10);
         sessionStorage.removeItem(KEY);
         const targetId = "{{ scroll_to }}";
         const target = targetId ? document.getElementById(targetId) : null;
         requestAnimationFrame(() => requestAnimationFrame(() => {
            s.scrollTop = prev;
            if (!target) return;
            const offset = 80;
            const top = target.getBoundingClientRect().top - s.getBoundingClientRect().top + s.scrollTop;
            if (top > s.scrollTop + s.clientHeight - offset)
               s.scrollTo({ top: top - offset, behavior: "smooth" });
         }));
      });
   })();
   </script>

   <script>
   document.addEventListener("DOMContentLoaded", () => {
      const track = document.querySelector(".progress-track");
      if (!track) return;
      const fill = track.querySelector(".progress-fill");
      if (fill) fill.style.width = (parseFloat(track.getAttribute("data-progress") || "0")) + "%";
   });
   </script>

   <script>
   document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll("form").forEach(form => {
         form.addEventListener("submit", (e) => {
            const sub = e.submitter;
            if (!sub) return;
            sub.classList.add("loading");
            sub.innerText = "Thinking‚Ä¶";
            form.querySelectorAll('button[type="submit"]').forEach(b => { if (b !== sub) b.disabled = true; });
            setTimeout(() => { sub.disabled = true; }, 0);
         });
      });
   });
   </script>

   <script>
   function copyContextPrompt(btn) {
      const raw = document.getElementById("context-prompt-raw");
      if (!raw) return;
      navigator.clipboard.writeText(raw.value).then(() => {
         btn.textContent = "Copied!";
         btn.classList.add("copied");
         setTimeout(() => { btn.textContent = "Copy"; btn.classList.remove("copied"); }, 2000);
      });
   }
   </script>

   </body>
</html>